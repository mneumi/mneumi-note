### 缓存收益与成本

* 收益
  * 加速读写
  * 降低后端、持久层的负载和压力
* 成本
  * 可能导致数据不一致
  * 代码运维成本
  * redis节点运维成本



### 缓存更新策略

| 策略             | 一致性 | 维护成本 | 介绍                     |
| ---------------- | ------ | -------- | ------------------------ |
| LRU/LIRS算法剔除 | 最差   | 底       | 剔除最近最少使用的数据   |
| 超时剔除         | 较差   | 底       | 定时删除、惰性删除       |
| 主动更新         | 最好   | 高       | 持久层更新，缓存层也更新 |



### 缓存粒度

* 缓存粒度概念

  * 缓存中数据存储的规模
  * 全部存储、部分存储

* 全部存储、部分存储对比

  | 存储方式 | 通用性 | 占用空间 | 代码维护 |
  | -------- | ------ | -------- | -------- |
  | 部分存储 | 弱     | 少       | 难       |
  | 全部存储 | 强     | 多       | 易       |



### 缓存雪崩

* 缓存雪崩概念
  * 由于缓存层宕机了，导致前端流量全部涌向持久层
  * 从而造成连锁反应，持久层也宕机了
* 缓存雪崩解决方法
  * 使用redis-sentinel和redis-cluster增强redis的高可用性
  * 提前演练



### 缓存无底洞

* 缓存无底洞概念
  * 当缓存集群中机器过多，且数据部分太分散时
  * 如果客户端的一个命令，需要从多个节点中获取数据才能完成
  * 那么可能由于网络传输的问题，导致机器越多，执行越慢
* 缓存无底洞解决
  * 减少网络请求的次数
  * 降低网络请求带来的消耗，比如加入连接池等等



### 缓存穿透

* 缓存穿透概念

  * 大量的请求不命中，既不命中redis也不命中持久层 

  * 示意图

    ![](https://github.com/gothicrush/learning/blob/master/Redis/10.%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98%E4%B8%8E%E4%BC%98%E5%8C%96/images/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F.PNG)

* 缓存穿透产生原因

  * 业务代码有问题，使用户请求一些不存在或不能访问的数据
  * 恶意攻击，爬虫

* 缓存穿透发现

  * 响应请求的时间
  * 查看日志记录

* 缓存穿透解决方法

  * 方法1：缓存空对象

    * 原理：当请求一个不存在的数据时，在redis层存储一个空对象

      ![](https://github.com/gothicrush/learning/blob/master/Redis/10.%E7%BC%93%E5%AD%98%E9%97%AE%E9%A2%98%E4%B8%8E%E4%BC%98%E5%8C%96/images/%E7%BC%93%E5%AD%98%E7%A9%BF%E9%80%8F%E8%A7%A3%E5%86%B3%E6%96%B9%E6%B3%951.PNG)

    * 缺点：占用更多的空间；可能导致数据不一致

  * 方法2：布隆过滤器

    * 原理：使用布隆过滤器
    * 缺点：很难设计和使用



### 热点key重建

* 热点key重建概念

  * 当一个数据突然成为热点时（比如微博的热点），且整个数据之前并没有在缓存时
  * 由于服务器是高并发的，所以可能会有多个线程都进行**将热点数据写入缓存**的操作
  * 这样很多的重复操作会带来非常大的性能消耗

* 热点key解决方法

  * 使用互斥锁
    * 原理：一个线程在准备重建时进行加锁，则其他线程不能再重建
    * 缺点：可能导致大量的线程在等待
  * 永远不过期策略
    * 【不懂】

* 两种方法对比

  | 方案           | 优点                 | 缺点                           |
  | -------------- | -------------------- | ------------------------------ |
  | 互斥锁         | 思路简单；保持一致性 | 存在死锁风险；可能很多线程等待 |
  | 永远不过期策略 | 杜绝很多线程等待问题 | 不保证一致性                   |

  